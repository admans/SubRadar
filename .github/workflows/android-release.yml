name: Build Android APK

on:
  # Trigger on Tag push (Standard way)
  push:
    tags:
      - 'v*'
  # Trigger manually from GitHub UI (Easier way)
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Tag (e.g. v1.3.2)'
        required: true
        default: 'v1.3.4.2'
      notes:
        description: 'Custom Notes (Optional)'
        required: false
        default: ''

jobs:
  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important: Fetch all history for git log

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # Install Translate Shell for automatic translation
      - name: Install Translate Shell
        run: |
          wget -qO trans git.io/trans
          chmod +x ./trans
          sudo mv trans /usr/local/bin/

      # 1. Determine Version
      - name: Set Version Variable
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION_TAG=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          else
            echo "VERSION_TAG=${{ github.ref_name }}" >> $GITHUB_ENV
          fi

      # 2. Generate Bilingual Changelog (Robust Version)
      - name: Generate Bilingual Changelog
        id: changelog
        run: |
          # Logic to determine the range of commits for the changelog
          # We want commits from the Previous Tag (exclusive) to Current HEAD (inclusive)
          
          # Check if HEAD is exactly a tag (e.g. triggered by tag push)
          if git describe --exact-match --tags HEAD >/dev/null 2>&1; then
             # If we are on a tag, we need to search backwards from its parent to find the previous tag
             PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          else
             # If we are NOT on a tag (e.g. workflow_dispatch on main), the closest reachable tag IS the previous release
             PREV_TAG=$(git describe --tags --abbrev=0 HEAD 2>/dev/null || echo "")
          fi
          
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found. Generating full log."
            LOG_RANGE="HEAD"
          else
            echo "Generating changelog from $PREV_TAG to HEAD..."
            LOG_RANGE="$PREV_TAG..HEAD"
          fi
          
          # Initialize content
          CONTENT=""

          # Function to generate section with translation
          generate_section() {
            TITLE="$1"
            GREP_PATTERN="$2"
            
            # Get logs matching the pattern
            LOGS=$(git log $LOG_RANGE --pretty=format:"%s (%h)" --grep="$GREP_PATTERN" -i || true)
            
            if [ ! -z "$LOGS" ]; then
              CONTENT="$CONTENT\n\n### $TITLE"
              
              # Process line by line
              while IFS= read -r line; do
                if [ ! -z "$line" ]; then
                  # Extract text without hash for better translation
                  CLEAN_MSG=$(echo "$line" | sed -E 's/ \([a-f0-9]+\)$//')
                  
                  # Translate: -b (brief), -s (source en), -t (target zh-CN), -e (engine google)
                  # 2>/dev/null to suppress warnings
                  TRANS=$(trans -b -e google -s en -t zh-CN "$CLEAN_MSG" 2>/dev/null | head -n1)
                  
                  CONTENT="$CONTENT\n- $line"
                  if [ ! -z "$TRANS" ] && [ "$TRANS" != "$CLEAN_MSG" ]; then
                     CONTENT="$CONTENT\n  <small>$TRANS</small>"
                  fi
                fi
              done <<< "$LOGS"
            fi
          }
          
          # 1. Features
          generate_section "ðŸš€ New Features | æ–°åŠŸèƒ½" "^\(feat\|add\|new\|implement\|feature\)"
          
          # 2. Fixes
          generate_section "ðŸ› Bug Fixes | é—®é¢˜ä¿®å¤" "^\(fix\|bug\|issue\|resolve\|repair\)"
          
          # 3. Improvements
          generate_section "ðŸ›  Improvements | æ”¹è¿›ä¼˜åŒ–" "^\(update\|refactor\|style\|chore\|perf\|docs\|optimize\)"
          
          # 4. Others (Catch-all, inverted grep)
          # Note: We skip translation for 'Others' to save time/api calls on minor things, 
          # or you can enable it by copying the logic above. Here we just list them.
          OTHERS=$(git log $LOG_RANGE --pretty=format:"- %s (%h)" --invert-grep --grep="^\(feat\|add\|new\|implement\|feature\|fix\|bug\|issue\|resolve\|repair\|update\|refactor\|style\|chore\|perf\|docs\|optimize\|Release\|Merge\)" -i || true)
          if [ ! -z "$OTHERS" ]; then
            CONTENT="$CONTENT\n\n### ðŸ“‹ Other Changes | å…¶ä»–æ›´æ”¹\n$OTHERS"
          fi
          
          # Handle multiline string for GitHub Actions output
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "CHANGELOG_BODY<<$EOF" >> $GITHUB_ENV
          echo -e "$CONTENT" >> $GITHUB_ENV
          echo "$EOF" >> $GITHUB_ENV

      - name: Install Dependencies
        run: npm install

      - name: Build Web App
        run: npm run build

      - name: Initialize Capacitor Android
        run: |
          npx cap add android
          npx cap sync

      # 3. Update Android Version
      - name: Update Android Version
        run: |
          CLEAN_VERSION=$(echo "${{ env.VERSION_TAG }}" | sed 's/^v//')
          sed -i "s/versionName \"1.0\"/versionName \"$CLEAN_VERSION\"/g" android/app/build.gradle
          sed -i "s/versionCode 1/versionCode ${{ github.run_number }}/g" android/app/build.gradle

      - name: Build APK (Debug)
        run: |
          cd android
          ./gradlew assembleDebug

      # 4. Rename APK
      - name: Rename APK
        run: |
          cd android/app/build/outputs/apk/debug/
          mv app-debug.apk SubRadar-${{ env.VERSION_TAG }}.apk

      # 5. Create Release with Bilingual Body
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: SubRadar ${{ env.VERSION_TAG }}
          files: android/app/build/outputs/apk/debug/SubRadar-${{ env.VERSION_TAG }}.apk
          body: |
            ## ðŸ“± Android APK Update
            
            Version: **${{ env.VERSION_TAG }}**
            
            ${{ github.event.inputs.notes }}
            
            ${{ env.CHANGELOG_BODY }}
            
            ---
            
            Download **SubRadar-${{ env.VERSION_TAG }}.apk** below.
          draft: false
          prerelease: false
